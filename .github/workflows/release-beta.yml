name: Release (Beta)

on:
  push:
    branches: [beta]

permissions:
  packages: write

concurrency:
  group: release-beta
  cancel-in-progress: false

jobs:
  test-and-build:
    name: Test & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: ./.github/actions/test-and-build

  compute-version:
    name: Compute Version
    needs: test-and-build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      docker_tag: ${{ steps.version.outputs.docker_tag }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Derive version from git
        id: version
        run: |
          # Find latest stable tag across all branches (tags on main aren't ancestors of beta)
          BASE_TAG=$(git tag -l 'otterbot-v[0-9]*.[0-9]*.[0-9]' --sort=-version:refname | grep -E '^otterbot-v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
          if [ -n "$BASE_TAG" ]; then
            BASE_VERSION=${BASE_TAG#otterbot-v}
            # Count commits on beta since it diverged from the tagged commit
            MERGE_BASE=$(git merge-base "$BASE_TAG" HEAD 2>/dev/null || echo "")
            if [ -n "$MERGE_BASE" ]; then
              COMMIT_COUNT=$(git rev-list ${MERGE_BASE}..HEAD --count)
            else
              COMMIT_COUNT=$(git rev-list HEAD --count)
            fi
          else
            BASE_VERSION="0.0.0"
            COMMIT_COUNT=$(git rev-list HEAD --count)
          fi
          SHORT_SHA=$(git rev-parse --short HEAD)
          VERSION="${BASE_VERSION}-beta.${COMMIT_COUNT}+${SHORT_SHA}"
          DOCKER_TAG="${BASE_VERSION}-beta.${COMMIT_COUNT}-${SHORT_SHA}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "docker_tag=${DOCKER_TAG}" >> "$GITHUB_OUTPUT"
          echo "Computed version: ${VERSION}"

  publish:
    name: Publish Container
    needs: compute-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Log in to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build and push
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6
        with:
          context: .
          push: true
          build-args: |
            BUILD_VERSION=${{ needs.compute-version.outputs.version }}
          tags: |
            ghcr.io/toosmooth/otterbot:beta
            ghcr.io/toosmooth/otterbot:${{ needs.compute-version.outputs.docker_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
